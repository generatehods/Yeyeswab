<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>YEYESWAB — Endocrine System DEX</title>

<style>
    body {
        background:#04080f;
        color:white;
        font-family:Arial;
        margin:0;
        padding:20px;
        text-align:center;
    }
    .card {
        background:#0c1424;
        padding:20px;
        border-radius:15px;
        max-width:380px;
        margin:0 auto;
        box-shadow:0 0 20px #000;
    }
    input, select {
        width:100%;
        padding:12px;
        border-radius:8px;
        border:none;
        margin-top:8px;
        font-size:16px;
    }
    button {
        width:100%;
        padding:14px;
        border:none;
        background:#23a6f2;
        border-radius:10px;
        color:white;
        margin-top:15px;
        font-size:18px;
    }
</style>
</head>
<body>

<h2>YEYESWAB — Simple Solana Swap (Endocrine System)</h2>

<div class="card">
    <button id="connectBtn">Connect Wallet</button>

    <h3 style="margin-top:25px;">Swap</h3>

    <input id="amountIn" type="number" placeholder="Amount In">

    <select id="tokenIn">
        </select>

    <select id="tokenOut" style="margin-top:10px;">
        </select>

    <button id="swapBtn">Swap</button>
</div>

<script type="module">
import {
    Connection,
    PublicKey,
    LAMPORTS_PER_SOL,
    Transaction
} from "https://esm.sh/@solana/web3.js";

// Definisikan token yang ingin kita tampilkan
const ALL_TOKENS = [
    { name: "SOL", mint: "So11111111111111111111111111111111111111112", decimals: 9 },
    { name: "USDC", mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGHZad949EoE", decimals: 6 },
    { name: "USDT", mint: "Es9vMFrzaCERzYLztsF6D2PfYZ7R6puj949iEzb7gA3y", decimals: 6 },
    { name: "JUP", mint: "JUPyiwrYJFskUPiHa7hkeR8bocQokkBZexzL8CyhrUD", decimals: 6 },
    { name: "WEN", mint: "5h7E2B5eB5tT4q1M12zS8f4fK6M22P7T4v8G4g6X6Q2", decimals: 5 },
    { name: "PYTH", mint: "HZ1xYq262h8T49oE4u8C1m7J4f7E7z4f7z4f7z4f7z4f", decimals: 6 }, // Mint PYTH di sini mungkin perlu diverifikasi
    { name: "ENDC", mint: "[GANTI DENGAN MINT ADDRESS ENDOCRINE SYSTEM]", decimals: 6 }, // Token Anda
    { name: "FROG", mint: "[GANTI DENGAN MINT ADDRESS FROG]", decimals: 6 },
];

const JUP_API = "https://quote-api.jup.ag/v6/quote";
const connection = new Connection("https://api.mainnet-beta.solana.com");

let wallet = null;

// --- Fungsi untuk mengambil saldo token ---
async function getWalletBalances(publicKey) {
    const balances = {};
    const walletPublicKey = new PublicKey(publicKey);

    // 1. Ambil Saldo SOL
    const solBalanceLamports = await connection.getBalance(walletPublicKey);
    balances["So11111111111111111111111111111111111111112"] = solBalanceLamports / LAMPORTS_PER_SOL;

    // 2. Ambil Saldo SPL Token (Semua Token Kecuali SOL)
    const tokenMints = ALL_TOKENS.filter(t => t.mint !== "So11111111111111111111111111111111111111112").map(t => new PublicKey(t.mint));
    
    for (const token of ALL_TOKENS.filter(t => t.mint !== "So11111111111111111111111111111111111111112")) {
        try {
            const tokenAccounts = await connection.getTokenAccountsByOwner(
                walletPublicKey,
                { mint: new PublicKey(token.mint) }
            );

            if (tokenAccounts.value.length > 0) {
                // Ambil saldo dari akun token pertama yang ditemukan
                const accountInfo = await connection.getTokenAccountBalance(tokenAccounts.value[0].pubkey);
                balances[token.mint] = accountInfo.value.uiAmount.toFixed(4); // Tampilkan 4 desimal
            } else {
                balances[token.mint] = 0;
            }
        } catch (error) {
            console.error(`Gagal mendapatkan saldo untuk ${token.name}:`, error);
            balances[token.mint] = 0;
        }
    }
    return balances;
}

// --- Fungsi untuk memperbarui dropdown dengan saldo ---
async function updateTokenOptions(balances) {
    const tokenInSelect = document.getElementById("tokenIn");
    const tokenOutSelect = document.getElementById("tokenOut");

    tokenInSelect.innerHTML = '';
    tokenOutSelect.innerHTML = '';

    ALL_TOKENS.forEach(token => {
        const balance = balances[token.mint] || 0;
        const optionText = `${token.name} (${parseFloat(balance).toLocaleString()})`;
        
        const optionIn = document.createElement('option');
        optionIn.value = token.mint;
        optionIn.textContent = optionText;
        tokenInSelect.appendChild(optionIn);

        const optionOut = document.createElement('option');
        optionOut.value = token.mint;
        optionOut.textContent = token.name; // Tidak perlu saldo di tokenOut
        tokenOutSelect.appendChild(optionOut);
    });
}

// --- Connect Wallet ---
document.getElementById("connectBtn").onclick = async () => {
    if (window.phantom?.solana) {
        try {
            const resp = await window.phantom.solana.connect();
            wallet = resp.publicKey.toString();
            document.getElementById("connectBtn").innerText = "Connected: " + wallet.substring(0,6) + "...";
            
            // Panggil fungsi untuk mengambil dan menampilkan saldo
            const balances = await getWalletBalances(wallet);
            updateTokenOptions(balances);

        } catch (err) {
            console.error("Koneksi ditolak atau gagal:", err);
            alert("Koneksi Wallet Gagal!");
        }
    } else {
        alert("Install Phantom Wallet!");
    }
};


// --- Swap ---
document.getElementById("swapBtn").onclick = async () => {
    if (!wallet) return alert("Connect wallet dulu");

    const amount = document.getElementById("amountIn").value;
    const inputMint = document.getElementById("tokenIn").value;
    const outputMint = document.getElementById("tokenOut").value;

    // Perlu mengetahui desimal yang benar untuk inputMint
    const inputTokenInfo = ALL_TOKENS.find(t => t.mint === inputMint);
    const amountMultiplier = 10 ** (inputTokenInfo ? inputTokenInfo.decimals : 9); 
    const amountInLamports = Math.floor(parseFloat(amount) * amountMultiplier).toString();


    // --- GET QUOTE ---
    const quote = await fetch(`${JUP_API}?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amountInLamports}&slippageBps=100`).then(r=>r.json());

    // Periksa jika quote gagal
    if (!quote || quote.error) {
        return alert("Gagal mendapatkan kuotasi dari Jupiter. Cek pasangan token atau jumlahnya. Error: " + (quote ? quote.error : "Unknown Error"));
    }

    // Tambahkan referral fee (0.3% = 30 bps)
    quote.feeBps = 30;
    quote.feeAccount = "FSqRLFnykDnCZ6mQdnn4GPPwNz6NEFYU7sHKmrrw1X5b";  // Alamat Wallet Fee Anda

    // --- GET SWAP TRANSACTION FROM JUPITER ---
    const swapTx = await fetch("https://quote-api.jup.ag/v6/swap-instructions", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            quoteResponse: quote,
            userPublicKey: wallet
        })
    }).then(r => r.json());

    // Periksa jika transaksi gagal
    if (!swapTx || swapTx.error) {
        return alert("Gagal membuat instruksi swap dari Jupiter. Error: " + (swapTx ? swapTx.error : "Unknown Error"));
    }
    
    // --- EXECUTE TRANSACTION ---
    try {
        const tx = Transaction.from(Buffer.from(swapTx.swapTransaction, "base64"));
        tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

        const signed = await window.phantom.solana.signTransaction(tx);
        const txid = await connection.sendRawTransaction(signed.serialize());
        
        alert("Swap Success!\nTX: " + txid);
        
        // Opsional: Muat ulang saldo setelah swap
        const balances = await getWalletBalances(wallet);
        updateTokenOptions(balances);
        
    } catch (e) {
        alert("Transaksi Ditolak atau Gagal: " + e.message);
    }
};
</script>
</body>
</html>
